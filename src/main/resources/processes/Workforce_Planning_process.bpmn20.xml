<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:flowable="http://flowable.org/bpmn"
             targetNamespace="http://www.flowable.org/processdef">

  <process id="workforcePlanningProcess"
           name="Workforce Planning Process"
           isExecutable="true">

    <!-- ========================= -->
    <!-- START -->
    <!-- ========================= -->
    <startEvent id="startEvent"/>

    <!-- ========================= -->
    <!-- DEPARTMENT HEAD APPROVAL -->
    <!-- ========================= -->
    <userTask id="departmentApproval"
              name="Department Approval"
              flowable:assignee="departmentHead">
      <extensionElements>
        <flowable:formProperty id="approved"
                               name="Approve Project?"
                               type="boolean"
                               required="true"/>
      </extensionElements>
    </userTask>

    <sequenceFlow sourceRef="startEvent" targetRef="departmentApproval"/>

    <!-- UPDATE PROJECT STATUS -->
    <serviceTask id="updateProjectStatus"
                 name="Update Project Status"
                 flowable:delegateExpression="${projectApprovalDelegate}"/>

    <sequenceFlow sourceRef="departmentApproval" targetRef="updateProjectStatus"/>

    <!-- APPROVAL GATEWAY -->
    <exclusiveGateway id="approvalGateway"/>

    <sequenceFlow sourceRef="updateProjectStatus" targetRef="approvalGateway"/>

    <!-- ========================= -->
    <!-- REJECTED -->
    <!-- ========================= -->
    <endEvent id="endRejected" name="Rejected by Department Head"/>

    <sequenceFlow sourceRef="approvalGateway" targetRef="endRejected">
      <conditionExpression xsi:type="tFormalExpression">
        <![CDATA[${approved == false}]]>
      </conditionExpression>
    </sequenceFlow>

    <!-- ========================= -->
    <!-- RESOURCE PLANNER -->
    <!-- ========================= -->
    <userTask id="resourcePlannerTask"
              name="Allocate Employees"
              flowable:assignee="resourcePlanner">
      <extensionElements>
        <flowable:formProperty id="employeeIds"
                               name="Employee IDs"
                               type="json"
                               required="true"/>
      </extensionElements>
    </userTask>

    <sequenceFlow sourceRef="approvalGateway" targetRef="resourcePlannerTask">
      <conditionExpression xsi:type="tFormalExpression">
        <![CDATA[${approved == true}]]>
      </conditionExpression>
    </sequenceFlow>

    <!-- ASSIGN EMPLOYEES -->
    <serviceTask id="assignEmployees"
                 name="Assign Employees"
                 flowable:delegateExpression="${assignmentDelegate}"/>

    <sequenceFlow sourceRef="resourcePlannerTask" targetRef="assignEmployees"/>

    <!-- NOTIFY EMPLOYEES -->
    <serviceTask id="notifyEmployees"
                 name="Notify Employees"
                 flowable:delegateExpression="${notificationDelegate}"/>

    <sequenceFlow sourceRef="assignEmployees" targetRef="notifyEmployees"/>

    <!-- ========================= -->
    <!-- EMPLOYEE CONFIRMATION -->
    <!-- (MULTI-INSTANCE) -->
    <!-- ========================= -->
    <userTask id="employeeConfirmation"
              name="Employee Confirmation"
              flowable:assignee="${employeeId}">
      <extensionElements>
        <flowable:formProperty id="confirmed"
                               name="Confirm Assignment?"
                               type="boolean"
                               required="true"/>
      </extensionElements>

      <multiInstanceLoopCharacteristics
              isSequential="false"
              flowable:collection="${employeeIds}"
              flowable:elementVariable="employeeId"/>
    </userTask>

    <sequenceFlow sourceRef="notifyEmployees" targetRef="employeeConfirmation"/>

    <!-- ========================= -->
    <!-- COMPLETE PROJECT -->
    <!-- ========================= -->
    <serviceTask id="completeProject"
                 name="Complete Project"
                 flowable:delegateExpression="${projectCompletionDelegate}"/>

    <sequenceFlow sourceRef="employeeConfirmation" targetRef="completeProject"/>

    <endEvent id="endCompleted" name="Project Completed"/>

    <sequenceFlow sourceRef="completeProject" targetRef="endCompleted"/>

  </process>
</definitions>
