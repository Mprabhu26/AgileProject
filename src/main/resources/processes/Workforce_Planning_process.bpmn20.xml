<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:flowable="http://flowable.org/bpmn"
             targetNamespace="http://www.workforce.com">

  <process id="workforcePlanningProcess"
           name="Workforce Planning Process"
           isExecutable="true">

    <!-- Start -->
    <startEvent id="startEvent" name="Start" />
    <sequenceFlow id="flow1" sourceRef="startEvent" targetRef="projectStartTask" />

    <!-- 1. Project Initialization -->
    <serviceTask id="projectStartTask"
                 name="Initialize Project Workflow"
                 flowable:class="com.workforce.workforceplanning.workflow.ProjectStartDelegate" />
    <sequenceFlow id="flow2" sourceRef="projectStartTask" targetRef="resourcePlannerTask" />

    <!-- 2. Resource Planner Task (FIND EMPLOYEES) -->
    <userTask id="resourcePlannerTask"
              name="Find Suitable Employees"
              flowable:candidateGroups="ResourcePlanner">
      <documentation>
        Search for employees with matching skills and propose them for the project
      </documentation>
    </userTask>
    <sequenceFlow id="flow3" sourceRef="resourcePlannerTask" targetRef="departmentApprovalTask" />

    <!-- 3. Department Head Approval (APPROVE EMPLOYEES) -->
    <userTask id="departmentApprovalTask"
              name="Approve Employee Assignments"
              flowable:candidateGroups="DepartmentHead">
      <documentation>
        Review and approve/reject employees proposed by Resource Planner
      </documentation>
    </userTask>
    <sequenceFlow id="flow4" sourceRef="departmentApprovalTask" targetRef="projectApprovalTask" />

    <!-- 3b. Process the approval decision -->
    <serviceTask id="projectApprovalTask"
                 name="Process Approval Decision"
                 flowable:class="com.workforce.workforceplanning.workflow.ProjectApprovalDelegate" />
    <sequenceFlow id="flow5" sourceRef="projectApprovalTask" targetRef="approvalGateway" />

    <!-- 4. Approval Decision Gateway -->
    <exclusiveGateway id="approvalGateway" name="Approval Decision" />

    <!-- Approved path -->
    <sequenceFlow id="approvedFlow"
                  sourceRef="approvalGateway"
                  targetRef="assignmentTask">
      <conditionExpression xsi:type="tFormalExpression">
        ${approved == true}
      </conditionExpression>
    </sequenceFlow>

    <!-- Rejected path -->
    <sequenceFlow id="rejectedFlow"
                  sourceRef="approvalGateway"
                  targetRef="rejectEnd">
      <conditionExpression xsi:type="tFormalExpression">
        ${approved == false}
      </conditionExpression>
    </sequenceFlow>

    <!-- 5. Assign Employees (if approved) -->
    <serviceTask id="assignmentTask"
                 name="Assign Employees to Project"
                 flowable:class="com.workforce.workforceplanning.workflow.AssignmentDelegate" />
    <sequenceFlow id="flow7" sourceRef="assignmentTask" targetRef="notificationTask" />

    <!-- 6. Send Notifications -->
    <serviceTask id="notificationTask"
                 name="Send Assignment Notifications"
                 flowable:class="com.workforce.workforceplanning.workflow.NotificationDelegate" />
    <sequenceFlow id="flow8" sourceRef="notificationTask" targetRef="projectCompletionTask" />

    <!-- 7. Complete Project Setup -->
    <serviceTask id="projectCompletionTask"
                 name="Complete Project Setup"
                 flowable:class="com.workforce.workforceplanning.workflow.ProjectCompletionDelegate" />
    <sequenceFlow id="flow9" sourceRef="projectCompletionTask" targetRef="endEvent" />

    <!-- End Events -->
    <endEvent id="endEvent" name="Project Staffed and Ready" />
    <endEvent id="rejectEnd" name="Project Rejected" />

  </process>

</definitions>