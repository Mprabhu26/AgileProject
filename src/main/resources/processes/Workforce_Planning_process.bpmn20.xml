<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:flowable="http://flowable.org/bpmn"
             targetNamespace="http://www.workforce.com">

    <process id="workforcePlanningProcess"
             name="Workforce Planning Process"
             isExecutable="true">

        <!-- Start -->
        <startEvent id="startEvent" name="Start" />
        <sequenceFlow id="flow1" sourceRef="startEvent" targetRef="projectStartTask" />

        <!-- 1. Project Initialization -->
        <serviceTask id="projectStartTask"
                     name="Initialize Project Workflow"
                     flowable:delegateExpression="${projectStartDelegate}" />
        <sequenceFlow id="flow2" sourceRef="projectStartTask" targetRef="departmentApprovalTask" />

        <!-- 2. Department Head Approval -->
        <userTask id="departmentApprovalTask"
                  name="Approve Staffing Request"
                  flowable:candidateGroups="DepartmentHead">
            <documentation>
                Department Head reviews and approves/rejects the project staffing request based on priorities and budget
            </documentation>
        </userTask>
        <sequenceFlow id="flow3" sourceRef="departmentApprovalTask" targetRef="projectApprovalTask" />

        <!-- 3. Process Department Head Decision -->
        <serviceTask id="projectApprovalTask"
                     name="Process Department Approval"
                     flowable:delegateExpression="${projectApprovalDelegate}" />
        <sequenceFlow id="flow4" sourceRef="projectApprovalTask" targetRef="approvalGateway" />

        <!-- 4. Approval Decision Gateway -->
        <exclusiveGateway id="approvalGateway" name="Approved?" />

        <!-- Approved path -->
        <sequenceFlow id="approvedFlow"
                      sourceRef="approvalGateway"
                      targetRef="resourcePlannerTask">
            <conditionExpression xsi:type="tFormalExpression">
                ${approved == true}
            </conditionExpression>
        </sequenceFlow>

        <!-- Rejected path -->
        <sequenceFlow id="rejectedFlow"
                      sourceRef="approvalGateway"
                      targetRef="rejectEnd">
            <conditionExpression xsi:type="tFormalExpression">
                ${approved == false}
            </conditionExpression>
        </sequenceFlow>

        <!-- 5. Resource Planner Proposes Employees -->
        <userTask id="resourcePlannerTask"
                  name="Propose Employees for Assignment"
                  flowable:candidateGroups="ResourcePlanner">
            <documentation>
                Resource Planner searches for employees with matching skills and proposes them for assignment.
            </documentation>
        </userTask>
        <sequenceFlow id="flow5" sourceRef="resourcePlannerTask" targetRef="assignmentTask" />

        <!-- 6. Create Assignments BEFORE asking employee to confirm -->
        <serviceTask id="assignmentTask"
                     name="Create Employee Assignments"
                     flowable:delegateExpression="${assignmentDelegate}" >
            <documentation>
                System creates assignments for the proposed employees.
                Assignments are created in database and employees are marked as unavailable.
            </documentation>
        </serviceTask>
        <sequenceFlow id="flow6" sourceRef="assignmentTask" targetRef="notificationTask" />

        <!-- 7. Send Notifications to Employees -->
        <serviceTask id="notificationTask"
                     name="Send Assignment Notifications"
                     flowable:delegateExpression="${notificationDelegate}" >
            <documentation>
                System sends notifications to assigned employees informing them of their new assignment.
            </documentation>
        </serviceTask>
        <sequenceFlow id="flow7" sourceRef="notificationTask" targetRef="employeeConfirmationTask" />

        <!-- 8. EMPLOYEE CONFIRMATION (Now assignments exist to confirm!) -->
        <userTask id="employeeConfirmationTask"
                  name="Confirm Assignment"
                  flowable:candidateGroups="Employee">
            <documentation>
                Employee reviews the assignment and can:
                - Confirm participation (workflow continues)
                - Raise scheduling conflicts (goes back to Resource Planner)
            </documentation>
        </userTask>
        <sequenceFlow id="flow8" sourceRef="employeeConfirmationTask" targetRef="employeeDecisionGateway" />

        <!-- 9. Employee Decision Gateway -->
        <exclusiveGateway id="employeeDecisionGateway" name="Employee Confirmed?" />

        <!-- Employee CONFIRMS → Complete workflow -->
        <sequenceFlow id="employeeConfirmedFlow"
                      sourceRef="employeeDecisionGateway"
                      targetRef="projectCompletionTask">
            <conditionExpression xsi:type="tFormalExpression">
                ${employeeConfirmed == true}
            </conditionExpression>
        </sequenceFlow>

        <!-- Employee REJECTS → Go back to Resource Planner to find different employees -->
        <sequenceFlow id="employeeRejectedFlow"
                      sourceRef="employeeDecisionGateway"
                      targetRef="resourcePlannerTask">
            <conditionExpression xsi:type="tFormalExpression">
                ${employeeConfirmed == false}
            </conditionExpression>
        </sequenceFlow>

        <!-- 10. Complete Project Setup -->

        <serviceTask id="projectCompletionTask"
                     name="Complete Project Setup"
                     flowable:delegateExpression="${projectCompletionDelegate}" >
            <documentation>
                Mark project as fully staffed and ready to begin.
                Project status is updated to IN_PROGRESS.
            </documentation>
        </serviceTask>
        <sequenceFlow id="flow9" sourceRef="projectCompletionTask" targetRef="endEvent" />

        <!-- End Events -->
        <endEvent id="endEvent" name="Project Staffed Successfully">
            <documentation>
                Workflow completed successfully. All employees have been assigned and have confirmed participation.
            </documentation>
        </endEvent>

        <endEvent id="rejectEnd" name="Staffing Request Rejected">
            <documentation>
                Department Head rejected the staffing request. Project remains in REJECTED status.
            </documentation>
        </endEvent>

    </process>

</definitions>
